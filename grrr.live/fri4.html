<html>
<head>
  <style>
  html, body {
    height: 100%;
    width: 100%;
    padding: 0px;
    margin: 0px;
    color:#000;
    font-size: 10;
    overflow:auto;
    
  	white-space: -moz-pre-wrap; /* Firefox 1.0-2.0 */
  	white-space: pre-wrap;      /* current browsers */
  	font-family: monospace;
  }
  </style>
</head>

<body><div id="post">Loading...</div>
<script>

///// utils /////

// get url args:
var querystring = (function() {
	var qstr = window.location.search;
	var query = {};
	var a = qstr.substr(1).split('&');
	for (var i = 0; i < a.length; i++) {
		var b = a[i].split('=');
		query[decodeURIComponent(b[0])] = decodeURIComponent(b[1] || '');
	}
	return query;
})();

// debug messaging:
function post(msg) {
	document.getElementById("post").innerHTML = msg;
}

///// websocket /////

var wsocket; 
var connected = false;
var connectTask;

function ws_connect() {
	if (connected) return;
    if ('WebSocket' in window) {
        post('Connecting');
        var host = querystring.host || "localhost";
        var port = querystring.port || "8088";
        var address = "ws://" + host + ":" + port;
        wsocket = new WebSocket(address);
        wsocket.onopen = function(ev) {        
            post('CONNECTED to ' + address);
            connected = true;
            // cancel the auto-reconnect task:
            if (connectTask != undefined) clearInterval(connectTask);
            // apparently this first reply is necessary
            //send(['query api']);
            send("ok");
        };

        wsocket.onclose = function(ev) {
            post('DISCONNECTED from ' + address);
            connected = false;
            // set up an auto-reconnect task:
            connectTask = setInterval(ws_connect, 1000);
        };

        wsocket.onmessage = function(ev) {
        	handlemessage(ev.data);
        };

        wsocket.onerror = function(ev) {
            post("WebSocket error");
        };

    } else {
        post("WebSockets are not available in this browser!!!");
    }
}

function send(msg) {
	if(wsocket != undefined) wsocket.send(msg);
	post("sent:" + msg);
}

///// sequencing /////

function random(n) {
	return Math.floor(Math.random()*n);
}

function pick(arr) {
	return arr[random(arr.length)];
}

var mul = 1;

var notes = [36, 38, 42, ]; //,  41, 43, 45];

function seq(beat) {
	if (beat == 0) {
		mul = 1 + (mul % 4);
	}
	var msgarr = []; 
	// generate some randomized beats:
	var div = 4; //Math.pow(2, (beat+mul+1) % 4);
	var lim = div;
	var n = pick(notes); //36 + (beat*3)%16; //notes[beat % notes.length]; //pick(notes)
	for (var i=0; i<lim; i++) {
		// timestamp within beat (0..1)
		var t = i/lim; //random(div)/div;
		// MIDI note value
		
		// MIDI velocity
		var v = 60; //(1-t) * (1-t) * (1-t) * 100; //64 + random(32);
		// duration (ms)
		var d = 100; //(beat+1) * (beat+1) * (t+1) * 6;
		// seq~ schedule format:
		// add <seqid> <phase> <arguments...>
		// seqid is the beat number
		// phase is 0..1 within that beat
		// arguments is a max message, as space-delimited strings and numbers
		msgarr.push("add " + beat + " " + t + " note " + n + " " + v + " " + d);
		
		var cc = 34 + random(2);
		var cv = Math.random();
		//msgarr.push("add " + beat + " " + t + " param " + cc + " " + cv);
	}
	send(msgarr);	// sends array as comma-delimited strings
}

function handlemessage(msg) {
	if (msg.substr(0, 4) == "seq ") {
		var beat = +msg.substr(4);
		// send a response:
		seq(beat);
	} else if (msg.substr(0, 4) == "api ") {
		var api = JSON.parse(msg.substr(4));
		post(JSON.stringify(api, null, "   "));
	} else {
		post(msg);
	}
}

///// start up /////

ws_connect();

</script>
</body>
</html>