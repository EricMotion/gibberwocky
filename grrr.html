<html>
<head>
  <style>
  html, body {
    height: 100%;
    width: 100%;
    padding: 0px;
    margin: 0px;
    color:#000;
    font-family:'Helvetica', sans-serif;
    overflow:hidden;
  }
  </style>
</head>

<body>
<div id="info">Hello.</div>
<script>
var wsocket; // websocket

function writeToScreen(msg) {
	document.getElementById("info").innerHTML = msg;
}

function send(msg) {
	if(wsocket != undefined) {
		wsocket.send(msg);
	}
	writeToScreen(msg);
}

var notes = [ 60, 62, 64, 65, 67, 69, 71, 72 ];

function random(n) {
	return Math.floor(Math.random()*n);
}

function pick(arr) {
	return arr[random(arr.length)];
}

function seq(seqname) {
	var msg = []; 
	msg.push("delete " + seqname + " -1 2."); // clear over all valid timepoints
	for (var i=0; i<16; i++) {
		var div = Math.pow(2, random(3));
		var t = random(div)/div;
		msg.push("add " + seqname + " " + t + " " + pick(notes) + " " + (64 + random(32)));
	}
	send(msg);
	//send(JSON.stringify({data:msg}));
}

function ws_connect() {
    if ('WebSocket' in window) {
        writeToScreen('Connecting');
        wsocket = new WebSocket('ws://localhost:8088/maxmsp');
        wsocket.onopen = function(ev) {        
            writeToScreen('CONNECTED');
            var message = 'update on';
            writeToScreen('SENT: ' + message);
            wsocket.send(message);
        };

        wsocket.onclose = function(ev) {
            writeToScreen('DISCONNECTED');
        };

        wsocket.onmessage = function(ev) {
        	if(ev.data.substr(0, 3) == "rx ") {
        		var msg = ev.data.substr(3);
        		if (msg.substr(0, 4) == "seq ") {
        			var beat = +msg.substr(4);
        			writeToScreen('seq: ' + beat);
        			
        			seq(beat);
        		}
        	}
          	//writeToScreen('RECEIVED: ' + ev.data);
        };

        wsocket.onerror = function(ev) {
            writeToScreen("WebSocket error");
        };

    } else {
        writeToScreen("WebSocket is not available!!!");
    }
}

ws_connect();

</script>
</body>

</html>